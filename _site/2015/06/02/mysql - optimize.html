<!doctype html>
<html>
<head>
  <meta charset="utf-8">
<title>Mysql优化小技巧 | 圣泉山人—随记</title>
<meta name="author" content="圣泉山人">


<link rel="shortcut icon" href="/public/img/myy.png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/public/css/bootstrap.css">
<link rel="stylesheet" href="/public/css/font-awesome.css">
<link rel="stylesheet" href="/public/js/prettify/prettify.css">
<link rel="stylesheet" href="/public/css/base.css">
<link href="/pages/atom.xml" rel="alternate" title="圣泉山人—随记" type="application/atom+xml">
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-3 col-lg-3 col-sm-13 col-xs-13 aside visible-md visible-lg">
  <div class="row">
    <div class="col-md-2 col-xs-2 aside1">
      <br>
      <a class="pjaxlink" href="/"><img src="/public/img/myy.png" class="img-ronuded avatar" style="border-width:0px; border-color:#000"></a>
      <br><br><br><br>
      <ul class="nav nav-pills nav-stacked">
             <!-- 这里是aside1的读书、生活、科研、技术、绘画-->
         <li><a href="#笔记" data-toggle="tab">笔记</a></li>
             <!-- 这里是aside1的读书、生活、科研、技术、绘画-->
         <li><a href="#php" data-toggle="tab">php</a></li>
             <!-- 这里是aside1的读书、生活、科研、技术、绘画-->
         <li><a href="#linux" data-toggle="tab">linux</a></li>
        
        <li><a href="#tags" data-toggle="tab">标签</a></li>  
        <li><a class="pjaxlink" href="/pages/archive.html">归档</a></li>
        <li><a class="pjaxlink" href="/pages/about.html">关于</a></li>  
        <!-- <li><a href="#tags" data-toggle="tab"><i class="fa fa-tags fa-lg"></i></a></li>
        <li><a class="pjaxlink" href="/pages/archive.html"><i class="fa fa-archive fa-lg"></i></a></li>
        <li><a class="pjaxlink" href="/pages/about.html"><i class="fa fa-user fa-lg"></i></a></li>
        这是原来现实汉字的代码，我改为了图标 -->
      </ul>
      <div class="aside1_bottom">
        <table class="table table-condensed">
          <tr>
            <td><a href="/pages/atom.xml" target="_blank"><i class="fa fa-rss fa-lg" style="color:#fff;"></i></a></td>
            <td><a href="mailto:myyd@outlook.com"><i class="fa fa-envelope-o fa-lg" style="color:#fff;"></i></a></td>
          </tr>
        </table>
      </div>
    </div>
    <div class="col-md-10 col-xs-10 aside2">
      <div class="row">
        <div class="tab-content"> 
           
            <div class="tab-pane" id="笔记">
              <div class="list-group">
                <!--<h2 class="center">笔记</h2>-->     <!--原来aside2上面的大标题-->
                
                  <a href="/2015/08/03/about-optimize.html" class="list-group-item-lay pjaxlink">高并发</a>
                
                  <a href="/2015/03/10/Git-Resources.html" class="list-group-item-lay pjaxlink">Git常用命令速查表</a>
                
                  <a href="/2015/03/01/files-upload.html" class="list-group-item-lay pjaxlink">php文件上传</a>
                
              </div>
            </div>
           
            <div class="tab-pane" id="php">
              <div class="list-group">
                <!--<h2 class="center">php</h2>-->     <!--原来aside2上面的大标题-->
                
                  <a href="/2015/09/06/Linux%20-%20memcache.html" class="list-group-item-lay pjaxlink">memcache实现高可用方案</a>
                
                  <a href="/2015/06/15/linux-nginx.html" class="list-group-item-lay pjaxlink">linux 环境下 php 扩展安装通用方法</a>
                
                  <a href="/2015/06/11/Lamp.html" class="list-group-item-lay pjaxlink">Linux下 nginx安装 + php-fpm安装</a>
                
                  <a href="/2015/06/02/mysql%20-%20optimize.html" class="list-group-item-lay pjaxlink">Mysql优化小技巧</a>
                
                  <a href="/2015/05/02/mysql-index%20.html" class="list-group-item-lay pjaxlink">Mysql索引文件本身的数据结构</a>
                
              </div>
            </div>
           
            <div class="tab-pane" id="linux">
              <div class="list-group">
                <!--<h2 class="center">linux</h2>-->     <!--原来aside2上面的大标题-->
                
                  <a href="/2015/07/06/Linux4.html" class="list-group-item-lay pjaxlink">Linux 4：磁盘与文件系统管理</a>
                
                  <a href="/2015/07/05/Linux3.html" class="list-group-item-lay pjaxlink">Linux 3：文件与目录管理</a>
                
                  <a href="/2015/07/04/Linux2.html" class="list-group-item-lay pjaxlink">Linux 2：文件权限与目录配置</a>
                
                  <a href="/2015/07/03/Linux.html" class="list-group-item-lay pjaxlink">Linux 1：登陆与在线求助man page</a>
                
                  <a href="/2015/07/02/Linux-Problems.html" class="list-group-item-lay pjaxlink">Linux 0：实际问题</a>
                
                  <a href="/2015/06/15/linux-redis.html" class="list-group-item-lay pjaxlink">Linux环境下redis的搭建</a>
                
                  <a href="/2015/05/20/linux-php.html" class="list-group-item-lay pjaxlink">linux 环境下 php 扩展安装通用方法</a>
                
              </div>
            </div>
                
          <div class="tab-pane" id="tags">
            <div class="panel-group" id="accordion">
              <!--<h2 class="center">标签</h2>-->
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#文件上传">文件上传</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="文件上传" class="panel-collapse collapse">
                    
                      <a  href='/2015/03/01/files-upload.html' class="list-group-item pjaxlink">
                        php文件上传
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Git">Git</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="Git" class="panel-collapse collapse">
                    
                      <a  href='/2015/03/10/Git-Resources.html' class="list-group-item pjaxlink">
                        Git常用命令速查表
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Mysql">Mysql</a>
                      <span class="badge pull-right">2</span>
                    </h4>
                  </div>
                  <div id="Mysql" class="panel-collapse collapse">
                    
                      <a  href='/2015/06/02/mysql%20-%20optimize.html' class="list-group-item pjaxlink">
                        Mysql优化小技巧
                      </a>
                    
                      <a  href='/2015/05/02/mysql-index%20.html' class="list-group-item pjaxlink">
                        Mysql索引文件本身的数据结构
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Linux、PHP">Linux、PHP</a>
                      <span class="badge pull-right">2</span>
                    </h4>
                  </div>
                  <div id="Linux、PHP" class="panel-collapse collapse">
                    
                      <a  href='/2015/06/15/linux-nginx.html' class="list-group-item pjaxlink">
                        linux 环境下 php 扩展安装通用方法
                      </a>
                    
                      <a  href='/2015/05/20/linux-php.html' class="list-group-item pjaxlink">
                        linux 环境下 php 扩展安装通用方法
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#Linux">Linux</a>
                      <span class="badge pull-right">6</span>
                    </h4>
                  </div>
                  <div id="Linux" class="panel-collapse collapse">
                    
                      <a  href='/2015/07/06/Linux4.html' class="list-group-item pjaxlink">
                        Linux 4：磁盘与文件系统管理
                      </a>
                    
                      <a  href='/2015/07/05/Linux3.html' class="list-group-item pjaxlink">
                        Linux 3：文件与目录管理
                      </a>
                    
                      <a  href='/2015/07/04/Linux2.html' class="list-group-item pjaxlink">
                        Linux 2：文件权限与目录配置
                      </a>
                    
                      <a  href='/2015/07/03/Linux.html' class="list-group-item pjaxlink">
                        Linux 1：登陆与在线求助man page
                      </a>
                    
                      <a  href='/2015/07/02/Linux-Problems.html' class="list-group-item pjaxlink">
                        Linux 0：实际问题
                      </a>
                    
                      <a  href='/2015/06/11/Lamp.html' class="list-group-item pjaxlink">
                        Linux下 nginx安装 + php-fpm安装
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#linux/redis">linux/redis</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="linux/redis" class="panel-collapse collapse">
                    
                      <a  href='/2015/06/15/linux-redis.html' class="list-group-item pjaxlink">
                        Linux环境下redis的搭建
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#高并发">高并发</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="高并发" class="panel-collapse collapse">
                    
                      <a  href='/2015/08/03/about-optimize.html' class="list-group-item pjaxlink">
                        高并发
                      </a>
                    
                  </div>
                </div>
               
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <h4 class="panel-title">
                      <a data-toggle="collapse" data-toggle="collapse" data-parent="#accordion" href="#memcache">memcache</a>
                      <span class="badge pull-right">1</span>
                    </h4>
                  </div>
                  <div id="memcache" class="panel-collapse collapse">
                    
                      <a  href='/2015/09/06/Linux%20-%20memcache.html' class="list-group-item pjaxlink">
                        memcache实现高可用方案
                      </a>
                    
                  </div>
                </div>
              
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
      <div class="col-md-13 col-lg-13 col-sm-13 col-xs-13 aside3">
        <div id="container">
          <div id="pjax">
            <div class="row">
  <div class="col-md-13 aside3-title">
    <br>
    <h2 id="#identifier">Mysql优化小技巧</h2>
    2015年06月02日
  </div>
  <div class="col-md-13 aside3-content">
    <hr>
    <div id="content">
      <h1>Mysql优化小技巧</h1>

<h2>索引碎片与维护</h2>

<blockquote>
<p>在长期的数据更新过程中, 索引文件和数据文件,都将产生空洞，形成碎片我们可以通过一个nop操作(不产生对数据实质影响的操作), 来修改表。比如: 表的引擎为InnoDB , 可以 <code>alter table tableName engine InnoDB</code>也可以<code>optimize table tableName</code>,也可以修复。</p>
</blockquote>

<p><strong>注意</strong>： 修复表的数据及索引碎片，就会把所有的数据文件重新整理一遍，对于这个过程，如果表的行数比较大，也是非常耗费资源的操作。所以，不能频繁的修复。</p>

<p><strong>建议</strong>：如果表的Update操作很频率，可以按 周/月 来修复，如果不频繁，可以更长的周期来做修复</p>

<h2>重复索引和冗余索引的思考</h2>

<blockquote>
<p>重复索引:：是指 在同1个列(如name)， 或者 顺序相同的几个列(name,age)， 建立了多个索引。称为重复索引，重复索引没有任何帮助，只会增大索引文件，拖慢更新速度，必须去除。冗余索引：冗余索引是指2个索引所覆盖的列有重叠， 称为冗余索引，比如 x,m列， 加索引  index x(x)，  index xm(x, m)。x、xm索引， 两者的x列重叠了， 这种情况,称为冗余索引，甚至可以把 index mx(m, x) 索引也建立， mx、xm  也不是重复的，列的顺序不一样。</p>
</blockquote>

<h2>in型子查询的陷阱</h2>

<p>在ecshop商品表中，查询6号栏目的商品（6号是一个大栏目）
最直观的：<br>
<code>mysql&gt; select goods_id,cat_id,goods_name from goods where cat_id in (select cat_id from ecs_category where parent_id=6);</code></p>

<p>误区： 给我们的感觉是， 先查到内层的6号栏目的子栏目，如7,8,9,11然后外层，cat<em>id in (7,8,,9,11)
实际上： 如下图, goods表全扫描， 并逐行与category表对照，看parent</em>id=6是否成立
<img src="http://myyphp.github.io/public/img/posts/mysql_optimize1.png" alt=""></p>

<p><img src="http://myyphp.github.io/public/img/posts/mysql_optimize2.png" alt=""></p>

<p><strong>原因： mysql的查询优化器，针对In型做优化，被改成了exists的执行效果，当goods表越大时， 查询速度越慢</strong></p>

<p>改进： 用连接查询来代替子查询
   <code>explain select goods_id,g.cat_id,g.goods_name from  goods as g inner join (select cat_id from ecs_category where parent_id=6) as t using(cat_id) \G</code></p>

<ol>
<li><p>内层 select cat<em>id from ecs</em>category where parent<em>id=6 ; 用到Parent</em>id索引，返回4行，形成结果,设为 t</p></li>
<li><p>第2次查询， t 和 goods 通过 cat<em>id 相连， 因为cat</em>id在 goods表中有索引，所以相当于用7,8,911，快速匹配上goods的行。</p></li>
</ol>

<h2>exists子查询</h2>

<p>题： 查询有商品的栏目.按上面的理解，我们用join来操作，如下：
    <code>mysql&gt; select c.cat_id, cat_name from ecs_category as c inner join  goods as  g on c.cat_id=g.cat_id group by cat_name;</code></p>

<ol>
<li><p>优化1： 在group时， 用带有索引的列来group， 速度会稍快一些,另外，用int型 比 char型分组，也要快一些</p></li>
<li><p>优化2： 在group时， 我们假设只取了A表的内容，group by 的列，尽量用A表的列，会比B表的列要快</p></li>
<li><p>优化3： 从语义上去优化</p></li>
</ol>

<p><code>select cat_id,cat_name from ecs_category where exists(select *from  goods where  goods.cat_id=ecs_category.cat_id)</code></p>

<h2>rom子查询</h2>

<p>注意：内层from语句查到的临时表，是没有索引的。所以： from的返回内容要尽量少max|min优化技巧</p>

<p>有如下的地区表：
<img src="http://myyphp.github.io/public/img/posts/mysql_optimize3.png" alt=""></p>

<p>我们查min(id)，id是主键，查min(id)非常快,但是，pid上没有索引， 现在要求查询3113地区的min(id)
<code>select min(id) from area where pid=69;</code></p>

<p>试想 id是有顺序的，(默认索引是升续排列)， 因此,如果我们沿着id的索引方向走，那么 第1个 pid=69的索引结点，他的id就正好是最小的id。
<code>select  id  from area use index(primary) where pid=69 limit 1;</code></p>

<h2>count() 优化</h2>

<p>误区： myisam的count()非常快</p>

<p>答: 是比较快，但仅限于查询表的”所有行”比较快，因为Myisam对行数进行了存储。一旦有条件的查询, 速度就不再快了。尤其是where条件的列上没有索引。</p>

<p>假如，id&lt;100的商家都是我们内部测试的，我们想查查真实的商家有多少?</p>

<p><code>select count(*) from tableName where id&gt;=100;</code></p>

<p>小技巧：</p>

<p><code>select count(*) from tableName ; 快</code>
<code>select count(*) from tableName where id &lt; 100; 快</code>
<code>select count(*) from tableName - select count(*) from tableName where id&lt;100; 快</code>
<code>select (select count(*) from tableName ) - (select count(*) from tableName where id&lt;100)</code></p>

<h2>group小技巧</h2>

<p>注意：分组用于统计，而不用于筛选数据.</p>

<p>比如： 统计平均分，最高分，适合； 但用于筛选重复数据，则不适合.。以及用索引来避免临时表和文件排序以A,B表连接为例 ，主要查询A表的列， 那么 <code>group by</code> ,<code>order by</code> 的列尽量相同，而且列应该显示声明为A的列</p>

<h2>union优化</h2>

<p>注意： <code>union all</code> 不过滤 效率提高，如非必须，请用<code>union all</code> ，因为 <code>union</code>去重的代价非常高，放在PHP程序里去重更合适</p>

    </div>
    <hr>
    <div id="disqus_thread">
  <button type="button" name="myyphp" class="btn btn-default show-commend">	
  	<i class="fa fa-comment-o fa-lg" style="color: #16a095;"></i>     <!-- 修改显示评论按钮图标-->
  </button>
</div>

  </div>
  <!-- 目录 -->
  <div id="content_table" style="position:fixed;right:20px;top:120px;display:none;">
    <div class="panel panel-success">
      <div class="panel-body" id="nav"></div>
    </div>
  </div>
</div>


          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="position:fixed;right:15px;top:62px;">
  <button id="content_btn" class="btn btn-primary" style="width:43px; height:34px;">
    <i class="fa fa-lg fa-plus"></i>
  </button>
</div>
<div style="position:fixed;right:15px;top:20px;">
  <button id="nav_btn" class="btn btn-primary">
    <i class="fa fa-lg fa-navicon"></i>
  </button>
</div>
<script type="text/javascript" src="/public/js/jquery.js"></script>
<script type="text/javascript" src="/public/js/bootstrap.js"></script>
<script src="/public/js/jquery.pjax.js"></script>
<script src="/public/js/prettify/prettify.js"></script>
<script src="/public/js/base.js"></script>
<!--
<script src="/public/js/jquery.scrollUp.js"></script>
-->
<script>
    $('a[href="#读书"]').tab('show');
</script>


<!--button是右上方导航和显示目录的按钮-->


  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-54262064-1', 'painterlin.com');
  ga('send', 'pageview');
</script>
</body>
</html>